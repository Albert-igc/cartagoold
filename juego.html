<script type="module">
    import { db, doc, updateDoc, onSnapshot, getDoc } from './firebase-config.js';
    import { bancoPreguntas } from './preguntas.js';

    document.addEventListener('DOMContentLoaded', () => {
        const rol = localStorage.getItem('miRol'); 
        const salaActual = localStorage.getItem('salaActual'); 
        const otroRol = rol === 'jugador1' ? 'jugador2' : 'jugador1';
        
        if (!rol || !salaActual) {
            window.location.href = 'index.html';
            return;
        }

        const partidaRef = doc(db, "salas", salaActual);
        const preguntas = bancoPreguntas;

        onSnapshot(partidaRef, (docSnap) => {
            if (docSnap.exists()) {
                gestionarEstado(docSnap.data());
            } else {
                window.location.href = 'index.html';
            }
        });

        function gestionarEstado(data) {
            const estado = data.estadoJuego || 'seleccion';
            const pantallas = {
                seleccion: document.getElementById('pantalla-seleccion'),
                juego: document.getElementById('pantalla-juego'),
                invitacion: document.getElementById('modal-invitacion'),
                espera: document.getElementById('msg-esperando-confirmacion')
            };

            if (estado === 'seleccion') {
                pantallas.seleccion?.classList.remove('oculto');
                pantallas.juego?.classList.add('oculto');
                pantallas.invitacion?.classList.add('oculto');
                pantallas.espera?.classList.add('oculto');
                const titulo = document.getElementById('titulo-modo');
                if(titulo) titulo.innerText = "Elige un Modo";
            }
            else if (estado === 'solicitando') {
                if (data.solicitante === rol) {
                    pantallas.espera?.classList.remove('oculto');
                } else {
                    const txtModo = document.getElementById('txt-modo-invitacion');
                    if(txtModo) txtModo.innerText = data.modoActual;
                    pantallas.invitacion?.classList.remove('oculto');
                }
            }
            else if (estado === 'jugando') {
                pantallas.invitacion?.classList.add('oculto');
                pantallas.espera?.classList.add('oculto');
                mostrarJuego(data);
            }
        }

        function mostrarJuego(data) {
            document.getElementById('pantalla-seleccion')?.classList.add('oculto');
            document.getElementById('pantalla-juego')?.classList.remove('oculto');
            
            const titulo = document.getElementById('titulo-modo');
            if(titulo) titulo.innerText = "Modo: " + (data.modoActual || "").toUpperCase();
            
            const lista = preguntas[data.modoActual];
            if(lista) {
                const index = data.indicePregunta % lista.length;
                const txtPregunta = document.getElementById('txt-pregunta');
                if(txtPregunta) txtPregunta.innerText = lista[index];
            }

            const ronda = data.preguntasEnEstaRonda || 1;
            const barra = document.getElementById('progreso-relleno');
            if(barra) barra.style.width = (ronda / 10) * 100 + "%";

            const miResp = data[`resp_${rol}`] || '';
            const suResp = data[`resp_${otroRol}`] || '';

            const areaResp = document.getElementById('area-respuesta');
            const mensajeEspera = document.getElementById('mensaje-espera');
            const verResp = document.getElementById('ver-respuestas');

            if (miResp === '') {
                areaResp?.classList.remove('oculto');
                mensajeEspera?.classList.add('oculto');
                verResp?.classList.add('oculto');
            } else if (suResp === '') {
                areaResp?.classList.add('oculto');
                mensajeEspera?.classList.remove('oculto');
                verResp?.classList.add('oculto');
            } else {
                areaResp?.classList.add('oculto');
                mensajeEspera?.classList.add('oculto');
                verResp?.classList.remove('oculto');
                const txtPartner = document.getElementById('txt-partner-resp') || document.getElementById('txt-respuesta-partner');
                if(txtPartner) txtPartner.innerText = suResp;
            }
        }

        // Exponer funciones al objeto window para los botones del HTML
        window.solicitarModo = async (modo) => {
            await updateDoc(partidaRef, { estadoJuego: 'solicitando', modoActual: modo, solicitante: rol });
        };

        window.responderInvitacion = async (acepta) => {
            if (acepta) {
                const snap = await getDoc(partidaRef);
                const data = snap.data();
                const total = preguntas[data.modoActual].length;
                await updateDoc(partidaRef, {
                    estadoJuego: 'jugando',
                    indicePregunta: Math.floor(Math.random() * total),
                    preguntasEnEstaRonda: 1,
                    resp_jugador1: '', resp_jugador2: ''
                });
            } else {
                await updateDoc(partidaRef, { estadoJuego: 'seleccion', modoActual: '', solicitante: '' });
            }
        };

        window.enviarRespuesta = async () => {
            const input = document.getElementById('mi-respuesta');
            if(!input?.value) return alert("Escribe algo amor ❤️");
            await updateDoc(partidaRef, { [`resp_${rol}`]: input.value });
        };

        window.siguientePregunta = async () => {
            const snap = await getDoc(partidaRef);
            const data = snap.data();
            const ronda = data.preguntasEnEstaRonda || 1;

            if (ronda < 10) {
                const total = preguntas[data.modoActual].length;
                await updateDoc(partidaRef, {
                    indicePregunta: Math.floor(Math.random() * total),
                    preguntasEnEstaRonda: ronda + 1,
                    resp_jugador1: '', resp_jugador2: ''
                });
            } else {
                await updateDoc(partidaRef, {
                    puntosJugador1: (data.puntosJugador1 || 0) + 100,
                    puntosJugador2: (data.puntosJugador2 || 0) + 100,
                    estadoJuego: 'seleccion',
                    resp_jugador1: '', resp_jugador2: ''
                });
                alert("¡Ronda completada! +100 puntos ❤️");
            }
        };

        window.salir = () => window.location.href = "dashboard.html";
    });
</script>
